{% extends "layout.html" %}
{% block main %}
<div class="container position-static mb-3">
    <ul class="list-unstyled text-center">
        <li class="mb-4 pt-3">
            <h1 class="fs-2"><旅行名><br>{{ trip_results[0][1] }}</h1> 
        </li>
        <li class="mb-4 pt-3">
            <h1 class="fs-2"><開始日><br>{{ trip_results[0][2] }}</h1> 
        </li>
        <li class="mb-4 pt-3">
            <h1 class="fs-2"><終了日><br>{{ trip_results[0][3] }}</h1> 
        </li>
        <li class="mb-4 pt-3">
            <h1 class="fs-2"><旅行のメンバー><br>{% for user_result in user_results %}{{ user_result[1]+"  "}}{% endfor %}</h1>
        </li>
    </ul>
    <div class="container mb-3"></div>
    <div class="row row-3 cols-3">
        {% for payment_result in payment_results %}
        <div class="card" style="width: 8rem;">
            <div class="card-body">
                <h5 class="card-title">{{ payment_result[5] }}</h5>
                <p class="card-text">{{ payment_result[3] }}</p>
                <form action="/payment_details" method="post">
                    <button class="btn btn-dark"　type="submit" name="payment_id" value="{{ payment_result[1] }}">見る</button>
                </form>
            </div>
        </div>
        {% endfor %}
        <form action="/payment_register" method="post">
            <button type="submit" class="btn btn-dark rounded-circle p-0" style="width:2rem;height:2rem;" name="trip_id1" value="{{ trip_results[0][0] }}">+</button>
        </form>
    </div>
</div>
<div class="text-center">
    <h1 class="fs-2"><メンバー清算額比率></h1>
    <canvas id="myPieChart"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
    <form action="/./liquidation" method="post">
        <button type="submit" class="btn btn-dark btn-lg" name="member_trip_id" value="{{ user_results|length,trip_results[0][0] }}">清算</button>
    </form>
    <script>
        let user_results = {{ user_results |tojson }};
        let payment_results = {{ payment_results |tojson }};
        let member_count = Number(user_results.length)
        var dic = {};
        var total = 0;
        for (let i=0; i<member_count; i++){
            dic[user_results[i][1]] = 0
            for (let j=0; j < Number(payment_results.length); j++) {
                if (user_results[i][0] == payment_results[j][0]){
                    dic[user_results[i][1]] += payment_results[j][3]
                }
            }
            total += dic[user_results[i][1]]
        }
        for (let i=0; i<member_count; i++){
            dic[user_results[i][1]] = dic[user_results[i][1]]*100/total
        }
   
        var array = Object.keys(dic).map((k)=>({ key: k, value: dic[k] }));
        array.sort((a, b) => - a.value + b.value);
        dic = Object.assign({}, ...array.map((item) => ({
            [item.key]: item.value,
        })));

        var user_list = Object.keys(dic)
        var data_list = Object.values(dic)

        var ctx = document.getElementById("myPieChart");
        var myPieChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: user_list,
            datasets: [{
                backgroundColor: [
                    "#BB5179",
                    "#FAFF67",
                    "#58A27C",
                    "#3C00FF"
                ],
                data: data_list
            }]
          },
          options: {
            title: {
              display: true,
            }
          }
        });
    </script>
</div>
</div>
{% endblock %}